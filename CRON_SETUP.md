# Инструкция по настройке Cron Jobs в Vercel

## Способ 1: Через vercel.json (уже настроено)

В файле `vercel.json` уже есть настройка Cron Jobs:

```json
"crons": [
  {
    "path": "/api/cron",
    "schedule": "0 9,21 * * *"
  }
]
```

Это означает:
- **Path**: `/api/cron` - endpoint для вызова
- **Schedule**: `0 9,21 * * *` - запуск в 09:00 и 21:00 каждый день

После деплоя Vercel автоматически создаст Cron Job на основе этой конфигурации.

## Способ 2: Через Vercel Dashboard (рекомендуется)

### Шаг 1: Войдите в Vercel Dashboard

1. Откройте https://vercel.com
2. Войдите в свой аккаунт
3. Выберите ваш проект `parser`

### Шаг 2: Перейдите в настройки Cron Jobs

1. В меню проекта выберите **Settings** (Настройки)
2. В левом меню найдите раздел **Cron Jobs** (или **Crons**)
3. Нажмите на него

### Шаг 3: Создайте новый Cron Job

1. Нажмите кнопку **Create Cron Job** (или **Add Cron Job**)
2. Заполните форму:

   **Path (Путь):**
   ```
   /api/cron
   ```

   **Schedule (Расписание):**
   ```
   0 9,21 * * *
   ```
   
   Это означает:
   - `0` - минута 0
   - `9,21` - часы 9 и 21 (09:00 и 21:00)
   - `*` - любой день месяца
   - `*` - любой месяц
   - `*` - любой день недели

3. Нажмите **Save** (Сохранить)

### Шаг 4: Проверка расписания

Vercel покажет вам:
- **Next Run** - когда будет следующий запуск
- **Timezone** - часовой пояс (обычно UTC)
- **Status** - статус (Active/Inactive)

## Формат расписания Cron

Формат: `минута час день_месяца месяц день_недели`

### Примеры расписаний:

| Расписание | Описание |
|------------|----------|
| `0 9,21 * * *` | В 09:00 и 21:00 каждый день |
| `0 */6 * * *` | Каждые 6 часов |
| `0 9 * * *` | Каждый день в 09:00 |
| `0 9 * * 1-5` | В 09:00 с понедельника по пятницу |
| `*/30 * * * *` | Каждые 30 минут |
| `0 0 * * *` | Каждый день в полночь |

### Важно о часовых поясах:

Vercel использует **UTC** (Coordinated Universal Time). 

Для Эстонии (EET/EEST, UTC+2/+3):
- 09:00 EET = 07:00 UTC
- 21:00 EET = 19:00 UTC

Если хотите запускать в 09:00 и 21:00 по эстонскому времени, используйте:
```
0 7,19 * * *
```

## Проверка работы Cron Job

### 1. Проверьте логи

1. В Vercel Dashboard перейдите в **Deployments**
2. Выберите последний деплой
3. Откройте вкладку **Functions**
4. Найдите `/api/cron` и посмотрите логи

### 2. Ручной тест

Вы можете вручную вызвать endpoint для тестирования:

```bash
curl -X POST https://your-project.vercel.app/api/cron
```

Или через браузер откройте:
```
https://your-project.vercel.app/api/cron
```

### 3. Проверка через API

После выполнения Cron Job проверьте результаты:
```
https://your-project.vercel.app/api/products
```

## Безопасность (опционально)

Если хотите защитить Cron endpoint от случайных вызовов:

### Шаг 1: Создайте секретный ключ

1. В Vercel Dashboard → Settings → Environment Variables
2. Добавьте новую переменную:
   - **Name**: `CRON_SECRET`
   - **Value**: любой случайный ключ (например: `my-secret-key-12345`)
   - **Environment**: Production, Preview, Development (по необходимости)
3. Нажмите **Save**

### Шаг 2: Vercel автоматически передаст ключ

Vercel автоматически добавит заголовок `Authorization: Bearer <ваш-ключ>` при вызове Cron Job.

Код уже готов для проверки этого ключа в `api/index.py`.

## Устранение проблем

### Cron Job не запускается

1. **Проверьте формат расписания:**
   - Используйте онлайн-валидатор: https://crontab.guru/
   - Убедитесь, что формат правильный: `минута час день месяц день_недели`

2. **Проверьте путь:**
   - Убедитесь, что endpoint `/api/cron` существует и работает
   - Проверьте через ручной вызов

3. **Проверьте логи:**
   - В Vercel Dashboard → Functions → Logs
   - Найдите ошибки при выполнении

4. **Проверьте план Vercel:**
   - Cron Jobs доступны на платных планах
   - На бесплатном плане (Hobby) может быть ограничение

### Ошибка 401 Unauthorized

Если вы настроили `CRON_SECRET`, но получаете ошибку:
- Убедитесь, что переменная окружения установлена
- Проверьте, что она доступна в нужном окружении (Production/Preview)

### Cron Job запускается, но не работает

1. Проверьте логи выполнения
2. Убедитесь, что парсер может получить доступ к сайтам
3. Проверьте, что база данных работает (на Vercel используйте `/tmp`)

## Альтернатива: Vercel Cron (новый формат)

Если у вас новая версия Vercel, можно использовать файл `vercel/crons.json`:

```json
{
  "crons": [
    {
      "path": "/api/cron",
      "schedule": "0 9,21 * * *"
    }
  ]
}
```

Но текущая настройка в `vercel.json` тоже работает.

## Мониторинг

Для мониторинга работы Cron Jobs:

1. **Vercel Dashboard → Cron Jobs:**
   - Показывает историю выполнения
   - Статус последних запусков
   - Время следующего запуска

2. **Логи:**
   - Все логи выполнения доступны в Functions → Logs
   - Можно фильтровать по endpoint `/api/cron`

## Рекомендации

1. **Начните с ручного теста:**
   - Сначала проверьте, что `/api/cron` работает при ручном вызове
   - Затем настройте автоматический запуск

2. **Используйте правильный часовой пояс:**
   - Учитывайте, что Vercel использует UTC
   - Пересчитайте время для вашего часового пояса

3. **Мониторьте первые запуски:**
   - После настройки проверьте несколько первых запусков
   - Убедитесь, что все работает корректно

4. **Настройте уведомления (опционально):**
   - В Vercel можно настроить уведомления об ошибках
   - Это поможет быстро узнать о проблемах
